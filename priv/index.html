<!--
! Excerpted from "Programming Erlang, Second Edition",
! published by The Pragmatic Bookshelf.
! Copyrights apply to this code. It may not be used to create training material, 
! courses, books, articles, and the like. Contact us if you are in doubt.
! We make no guarantees that this code is fit for any purpose. 
! Visit http://www.pragmaticprogrammer.com/titles/jaerlang2 for more book information.
-->
<html>
  <head>
    <title>Elixir Web Shell</title>
    <link rel="stylesheet" href="/static/ews.css" type="text/css">
    <script type="text/javascript" src="/static/jquery.min.js"></script>
    <script type="text/javascript">
      var websocket;
      var last_prompt = null;

      $(document).ready(init);

      function init() {
        init_input();

        if(!("WebSocket" in window)) {
          displayError('websockets are not supported!');
        } else {
          connect();
        }
      }

      function connect() {
        host = "ws://localhost:8080/websocket";
        websocket = new WebSocket(host);
        websocket.onopen = function(e) { onOpen(e) };
        websocket.onclose = function(e) { onClose(e) };
        websocket.onmessage = function(e) { onMessage(e) };
        websocket.onerror = function(e) { onError(e) };
      }

      function onOpen(e) {
        displayInfo('connected'); crlf();
      }

      function onClose(e) {
        displayInfo('disconnected'); crlf();
      }

      function onMessage(e) {
        try {
          obj = JSON && JSON.parse(e.data) || $.parseJSON(e.data) || nil;
          displayResponse(obj);
        } catch(err) {
          displayError("** Invalide server response : " + e.data); 
          crlf();
          if(last_prompt) {
            displayCommand(last_prompt);
          }
        }
      }

      function displayResponse(obj) {
        if(obj.hello) {
          displayInfo(obj.hello);
          crlf();
        }

        if(obj.result) {
          displayResult(obj.result);
          crlf();
        }

        if(obj.error) {
          displayError(obj.error);
          crlf();
        }

        if(obj.prompt) {
          last_prompt = obj.prompt;
          displayCommand(obj.prompt);
        }
      }

      function onError(e) {
        displayError('Server error: '+e.data);
      }

      function crlf() {
        $('#scroll').append('<br />');
      }
      function displayMessage(message, color) {
        $('#scroll').append('<span style="color:'+color+';">'+message+'</span>');
      }
      function displayError(message) {
        displayMessage(message, 'red');
      }
      function displayInfo(message) {
        displayMessage(message, 'green');
      }
      function displayCommand(command) {
        displayMessage(command, 'black');
      }
      function displayResult(result) {
        displayMessage(result, 'blue');
      }

      function sendCommand() {
        command = $("#input").val();
        displayCommand(command); crlf();
        if(websocket.readyState == websocket.OPEN){
          websocket.send(command);
        } else {
          displayError('not connected!');
        }
        $("#input").val("");
      }

      function init_input() {
        $("#input").each(function() {
          $(this).keyup(function(ev) {
            if(ev.keyCode == 13) {
              sendCommand();
            }
          })
        })
      }
    </script>
  </head>

  <body>
    <!-- <img src="/static/elixir.png" alt="Elixir Logo" /> -->
    <h2>EWS</h2>
    <p>version 0.0.1</p>
    <div id="scroll"></div>
    <p>
    <input type="text" id="input" class="live_input" />
  </body>
</html>
